<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pan Score | 首页</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=IBM+Plex+Sans+SC:wght@400;500;600&display=swap");

      :root {
        --bg-1: #07121b;
        --bg-2: #0a1d2b;
        --panel: rgba(11, 25, 36, 0.92);
        --panel-2: rgba(14, 33, 48, 0.96);
        --stroke: rgba(255, 255, 255, 0.08);
        --ink: #ecf2f6;
        --muted: #9fb2c1;
        --accent: #11b5a4;
        --accent-2: #37c5f0;
        --accent-3: #f39b5a;
        --shadow: rgba(3, 8, 12, 0.55);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: "DM Sans", "IBM Plex Sans SC", "Segoe UI", sans-serif;
        background:
          radial-gradient(900px 420px at 85% 15%, rgba(55, 197, 240, 0.16), transparent 60%),
          radial-gradient(700px 520px at 12% 20%, rgba(17, 181, 164, 0.14), transparent 55%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        padding: 24px 18px 48px;
      }

      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 3px 3px;
        opacity: 0.3;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 28px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        flex-wrap: wrap;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--ink);
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: conic-gradient(from 120deg, var(--accent), var(--accent-2), var(--accent-3));
        box-shadow: 0 12px 26px var(--shadow);
        position: relative;
      }

      .logo::after {
        content: "";
        position: absolute;
        inset: 5px;
        border-radius: 10px;
        background: #0b1822;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .brand-title {
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.95rem;
      }

      .brand-sub {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .nav {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .nav a {
        color: var(--ink);
        text-decoration: none;
        font-size: 0.9rem;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
      }

      .nav a:hover {
        border-color: rgba(255, 255, 255, 0.18);
      }

      .account {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .lang-select {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(8, 18, 26, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.86rem;
        color: var(--ink);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      }

      .lang-select select {
        border: 0;
        background: transparent;
        color: inherit;
        font-size: inherit;
        font-family: inherit;
        outline: none;
        cursor: pointer;
        padding: 2px 4px;
      }

      .lang-select span {
        font-size: inherit;
        color: inherit;
      }

      .lang-select select option {
        background: #0b1822;
        color: var(--ink);
      }

      .pill {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.86rem;
      }

      .user-pill {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        padding: 0;
        font-weight: 600;
        text-transform: uppercase;
      }

      .ghost-btn {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        border-radius: 999px;
        padding: 6px 12px;
        cursor: pointer;
      }

      .hero {
        position: relative;
        border-radius: 30px;
        overflow: hidden;
        background: #0a1a27;
        box-shadow: 0 24px 70px var(--shadow);
      }

      .hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(7, 18, 27, 0.92), rgba(7, 18, 27, 0.4));
        z-index: 1;
      }

      .hero-image {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: saturate(1.05);
      }

      .hero-content {
        position: relative;
        z-index: 2;
        padding: 36px;
        display: grid;
        gap: 16px;
      }

      .hero-label {
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 0.75rem;
        color: var(--accent-2);
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(2.2rem, 4vw, 3.4rem);
        line-height: 1.05;
      }

      .hero p {
        margin: 0;
        color: var(--muted);
        max-width: 560px;
        line-height: 1.6;
      }

      .hero-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .hero-meta span {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(8, 16, 24, 0.5);
      }

      .search-bar {
        display: flex;
        gap: 10px;
        background: rgba(5, 12, 18, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 999px;
        padding: 6px 8px 6px 16px;
        max-width: 620px;
      }

      .search-bar input {
        flex: 1;
        border: 0;
        background: transparent;
        color: var(--ink);
        font-size: 0.95rem;
        outline: none;
      }

      .search-bar button {
        border: 0;
        border-radius: 999px;
        padding: 8px 16px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #061017;
        font-weight: 600;
        cursor: pointer;
      }

      .section {
        display: grid;
        gap: 12px;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .section-header h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      .toggle {
        display: inline-flex;
        gap: 4px;
        background: rgba(10, 20, 28, 0.8);
        border-radius: 999px;
        padding: 4px;
        border: 1px solid var(--stroke);
      }

      .toggle button {
        border: 0;
        background: transparent;
        color: var(--ink);
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 999px;
        cursor: pointer;
      }

      .toggle button.active {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #07131d;
      }

      .card-row {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(170px, 1fr);
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 6px;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
      }

      .card-row::-webkit-scrollbar {
        height: 6px;
      }

      .card-row::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 999px;
      }

      .media-card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 18px;
        overflow: hidden;
        min-height: 310px;
        display: grid;
        grid-template-rows: 240px auto;
        box-shadow: 0 16px 40px var(--shadow);
        text-decoration: none;
        color: inherit;
      }

      .media-card.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .media-card.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 50px var(--shadow);
      }

      .poster {
        position: relative;
        background-size: cover;
        background-position: center;
      }

      .poster::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(7, 12, 18, 0.9));
      }

      .score {
        position: absolute;
        left: 12px;
        bottom: 12px;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: conic-gradient(var(--accent) calc(var(--score) * 1%), rgba(255, 255, 255, 0.2) 0);
        display: grid;
        place-items: center;
        color: var(--ink);
        font-weight: 600;
        z-index: 2;
      }

      .score::after {
        content: "";
        position: absolute;
        inset: 4px;
        border-radius: 50%;
        background: #0b1721;
        z-index: -1;
      }

      .score span {
        position: relative;
        font-size: 0.78rem;
      }

      .media-meta {
        padding: 12px 14px 16px;
        display: grid;
        gap: 6px;
      }

      .media-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin: 0;
      }

      .media-date {
        color: var(--muted);
        font-size: 0.82rem;
      }

      .row-status {
        font-size: 0.88rem;
        color: var(--muted);
      }

      .row-status.error {
        color: #f47174;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        header {
          justify-content: center;
        }

        .nav {
          justify-content: center;
        }

        .account {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 720px) {
        .hero-content {
          padding: 28px;
        }

        .search-bar {
          flex-direction: column;
          border-radius: 20px;
          align-items: stretch;
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header>
        <a class="brand" href="/home" aria-label="返回首页">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="brand-title">Pan Score</div>
            <div class="brand-sub">网盘链接评分与推荐</div>
          </div>
        </a>
        <nav class="nav"></nav>
        <div class="account">
          <div class="lang-select">
            <span>语言</span>
            <select id="language-select" aria-label="选择语言">
              <option value="zh-CN">中文</option>
              <option value="en-US">English</option>
            </select>
          </div>
          <div class="pill user-pill" id="user-pill">访客</div>
          <button class="ghost-btn" id="logout-btn" type="button">退出登录</button>
        </div>
      </header>

      <section class="hero" id="hero">
        <div class="hero-image" id="hero-image"></div>
        <div class="hero-content">
          <div class="hero-label">正在热议</div>
          <h1 id="hero-title">加载热门内容中...</h1>
          <p id="hero-overview">正在拉取 TMDB 数据，请稍候。</p>
          <div class="hero-meta" id="hero-meta"></div>
          <form class="search-bar" id="search-form" action="/search" method="get">
            <input id="search-input" name="q" type="search" placeholder="搜索电影、剧集或人物" />
            <button type="submit">搜索</button>
          </form>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h2>热门趋势</h2>
          <div class="toggle" id="trend-toggle">
            <button type="button" data-window="day" class="active">今日</button>
            <button type="button" data-window="week">本周</button>
          </div>
        </div>
        <div class="row-status" id="trending-status"></div>
        <div class="card-row" id="trending-row"></div>
      </section>

      <section class="section">
        <div class="section-header">
          <h2>正在流行</h2>
          <div class="toggle" id="popular-toggle">
            <button type="button" data-type="movie" class="active">电影</button>
            <button type="button" data-type="tv">剧集</button>
          </div>
        </div>
        <div class="row-status" id="popular-status"></div>
        <div class="card-row" id="popular-row"></div>
      </section>

    </main>

    <script>
      const heroImage = document.getElementById("hero-image");
      const heroTitle = document.getElementById("hero-title");
      const heroOverview = document.getElementById("hero-overview");
      const heroMeta = document.getElementById("hero-meta");
      const userPill = document.getElementById("user-pill");
      const languageSelect = document.getElementById("language-select");
      const logoutBtn = document.getElementById("logout-btn");
      const trendingRow = document.getElementById("trending-row");
      const trendingStatus = document.getElementById("trending-status");
      const popularRow = document.getElementById("popular-row");
      const popularStatus = document.getElementById("popular-status");
      const searchForm = document.getElementById("search-form");
      const searchInput = document.getElementById("search-input");

      const token = localStorage.getItem("access_token");
      const tmdbImageBase = "https://image.tmdb.org/t/p/";
      const defaultLanguage = "zh-CN";
      let currentTrendWindow = "day";
      let currentPopularType = "movie";

      const getPreferredLanguage = () => {
        const stored = localStorage.getItem("tmdb_language");
        if (stored) {
          return stored;
        }
        localStorage.setItem("tmdb_language", defaultLanguage);
        return defaultLanguage;
      };

      const applyLanguageSelection = () => {
        if (languageSelect) {
          languageSelect.value = getPreferredLanguage();
        }
      };

      const withLanguage = (url) => {
        const language = getPreferredLanguage();
        const joiner = url.includes("?") ? "&" : "?";
        return `${url}${joiner}language=${encodeURIComponent(language)}`;
      };

      const setUserPill = (label) => {
        const text = (label || "访客").trim();
        const initial = text ? text[0].toUpperCase() : "?";
        userPill.textContent = initial;
        userPill.title = label || "访客";
      };

      const buildImage = (path, size) => {
        if (!path) {
          return "linear-gradient(135deg, rgba(17, 181, 164, 0.3), rgba(55, 197, 240, 0.2))";
        }
        return `url(${tmdbImageBase}${size}${path})`;
      };

      const formatDate = (value) => {
        if (!value) {
          return "日期未知";
        }
        return value;
      };

      const clearRow = (row) => {
        row.innerHTML = "";
      };

      const setStatus = (el, message, isError = false) => {
        el.textContent = message;
        el.classList.toggle("error", isError);
      };

      const createCard = (item) => {
        const isTv = item.media_type === "tv" || (!item.media_type && item.first_air_date && !item.release_date);
        const isMovie = item.media_type === "movie" || (!item.media_type && item.release_date);
        const isLink = isTv || isMovie;
        const card = document.createElement(isLink ? "a" : "article");
        card.className = isLink ? "media-card clickable" : "media-card";
        if (isTv) {
          card.href = `/series/${item.id}`;
        } else if (isMovie) {
          card.href = `/movie/${item.id}`;
        }

        const poster = document.createElement("div");
        poster.className = "poster";
        poster.style.backgroundImage = buildImage(item.poster_path, "w342");

        const score = document.createElement("div");
        score.className = "score";
        const scoreValue = Math.round((item.vote_average || 0) * 10);
        score.style.setProperty("--score", scoreValue);
        const scoreText = document.createElement("span");
        scoreText.textContent = `${scoreValue}`;
        score.appendChild(scoreText);
        poster.appendChild(score);

        const meta = document.createElement("div");
        meta.className = "media-meta";

        const title = document.createElement("h3");
        title.className = "media-title";
        title.textContent = item.title || item.name || "未命名";

        const date = document.createElement("div");
        date.className = "media-date";
        date.textContent = formatDate(item.release_date || item.first_air_date);

        meta.appendChild(title);
        meta.appendChild(date);

        card.appendChild(poster);
        card.appendChild(meta);
        return card;
      };

      const renderRow = (row, items) => {
        clearRow(row);
        items.forEach((item) => {
          row.appendChild(createCard(item));
        });
      };

      const updateHero = (item) => {
        if (!item) {
          heroTitle.textContent = "暂无推荐";
          heroOverview.textContent = "请检查 TMDB 配置。";
          heroMeta.textContent = "";
          heroImage.style.backgroundImage = "";
          return;
        }

        heroTitle.textContent = item.title || item.name || "热门推荐";
        heroOverview.textContent = item.overview || "暂无简介";
        heroMeta.innerHTML = "";

        const metaItems = [
          item.media_type === "tv" ? "剧集" : "电影",
          formatDate(item.release_date || item.first_air_date),
          `评分 ${Math.round((item.vote_average || 0) * 10)}`,
        ];

        metaItems.forEach((text) => {
          const tag = document.createElement("span");
          tag.textContent = text;
          heroMeta.appendChild(tag);
        });

        heroImage.style.backgroundImage = buildImage(item.backdrop_path, "w1280");
      };

      const loadTrending = async (timeWindow) => {
        currentTrendWindow = timeWindow;
        setStatus(trendingStatus, "加载中...");
        try {
          const response = await fetch(withLanguage(`/api/v1/tmdb/trending?media_type=all&time_window=${timeWindow}`));
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "加载失败");
          }
          renderRow(trendingRow, data.results.slice(0, 12));
          setStatus(trendingStatus, "");
          updateHero(data.results[0]);
        } catch (error) {
          setStatus(trendingStatus, `热门趋势加载失败：${error.message}`, true);
        }
      };

      const loadPopular = async (type) => {
        currentPopularType = type;
        setStatus(popularStatus, "加载中...");
        try {
          const response = await fetch(withLanguage(`/api/v1/tmdb/popular?media_type=${type}`));
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "加载失败");
          }
          renderRow(popularRow, data.results.slice(0, 12));
          setStatus(popularStatus, "");
        } catch (error) {
          setStatus(popularStatus, `正在流行加载失败：${error.message}`, true);
        }
      };

      const initSession = async () => {
        if (!token) {
          setUserPill("未登录");
          setTimeout(() => {
            window.location.href = "/login";
          }, 800);
          return;
        }

        try {
          const response = await fetch("/api/v1/auth/me", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Session invalid");
          }

          const data = await response.json();
          setUserPill(data.email);
        } catch (error) {
          setUserPill("会话过期");
          localStorage.removeItem("access_token");
          setTimeout(() => {
            window.location.href = "/login";
          }, 800);
        }
      };

      document.getElementById("trend-toggle").addEventListener("click", (event) => {
        const button = event.target.closest("button");
        if (!button) {
          return;
        }
        const buttons = document.querySelectorAll("#trend-toggle button");
        buttons.forEach((btn) => btn.classList.toggle("active", btn === button));
        loadTrending(button.dataset.window);
      });

      document.getElementById("popular-toggle").addEventListener("click", (event) => {
        const button = event.target.closest("button");
        if (!button) {
          return;
        }
        const buttons = document.querySelectorAll("#popular-toggle button");
        buttons.forEach((btn) => btn.classList.toggle("active", btn === button));
        loadPopular(button.dataset.type);
      });

      searchForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const query = searchInput.value.trim();
        if (!query) {
          return;
        }
        window.location.href = `/search?q=${encodeURIComponent(query)}`;
      });

      languageSelect.addEventListener("change", () => {
        localStorage.setItem("tmdb_language", languageSelect.value);
        loadTrending(currentTrendWindow);
        loadPopular(currentPopularType);
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("access_token");
        window.location.href = "/login";
      });

      applyLanguageSelection();
      initSession();
      loadTrending("day");
      loadPopular("movie");
    </script>
  </body>
</html>
