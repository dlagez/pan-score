<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pan Score | 剧集详情</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=IBM+Plex+Sans+SC:wght@400;500;600&display=swap");

      :root {
        --bg-1: #07121b;
        --bg-2: #0a1d2b;
        --panel: rgba(11, 25, 36, 0.92);
        --panel-2: rgba(14, 33, 48, 0.96);
        --stroke: rgba(255, 255, 255, 0.08);
        --ink: #ecf2f6;
        --muted: #9fb2c1;
        --accent: #11b5a4;
        --accent-2: #37c5f0;
        --accent-3: #f39b5a;
        --shadow: rgba(3, 8, 12, 0.55);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: "DM Sans", "IBM Plex Sans SC", "Segoe UI", sans-serif;
        background:
          radial-gradient(900px 420px at 85% 15%, rgba(55, 197, 240, 0.16), transparent 60%),
          radial-gradient(700px 520px at 12% 20%, rgba(17, 181, 164, 0.14), transparent 55%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        padding: 24px 18px 48px;
      }

      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 3px 3px;
        opacity: 0.3;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        flex-wrap: wrap;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--ink);
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: conic-gradient(from 120deg, var(--accent), var(--accent-2), var(--accent-3));
        box-shadow: 0 12px 26px var(--shadow);
        position: relative;
      }

      .logo::after {
        content: "";
        position: absolute;
        inset: 5px;
        border-radius: 10px;
        background: #0b1822;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .brand-title {
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.95rem;
      }

      .brand-sub {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .account {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .lang-select {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(8, 18, 26, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.86rem;
        color: var(--ink);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      }

      .lang-select select {
        border: 0;
        background: transparent;
        color: inherit;
        font-size: inherit;
        font-family: inherit;
        outline: none;
        cursor: pointer;
        padding: 2px 4px;
      }

      .lang-select span {
        font-size: inherit;
        color: inherit;
      }

      .lang-select select option {
        background: #0b1822;
        color: var(--ink);
      }

      .pill {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.86rem;
      }

      .user-pill {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        padding: 0;
        font-weight: 600;
        text-transform: uppercase;
      }

      .ghost-btn {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        border-radius: 999px;
        padding: 6px 12px;
        cursor: pointer;
      }

      .hero {
        position: relative;
        border-radius: 28px;
        overflow: hidden;
        background: #0a1a27;
        box-shadow: 0 24px 70px var(--shadow);
      }

      .hero-backdrop {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: saturate(1.05);
      }

      .hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(7, 18, 27, 0.94), rgba(7, 18, 27, 0.4));
        z-index: 1;
      }

      .hero-content {
        position: relative;
        z-index: 2;
        display: grid;
        grid-template-columns: minmax(220px, 0.32fr) minmax(320px, 1fr);
        gap: 24px;
        padding: 28px;
      }

      .poster-card {
        background: rgba(7, 14, 20, 0.9);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        display: grid;
        grid-template-rows: 1fr auto;
        min-height: 360px;
      }

      .poster {
        background-size: cover;
        background-position: center;
        min-height: 320px;
      }

      .poster-actions {
        padding: 12px;
        display: grid;
        gap: 8px;
      }

      .poster-actions button {
        border: 0;
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(17, 181, 164, 0.18);
        color: var(--ink);
        cursor: pointer;
      }

      .hero-info {
        display: grid;
        gap: 14px;
        align-content: start;
      }

      .kicker {
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 0.75rem;
        color: var(--accent-2);
      }

      .hero-title {
        margin: 0;
        font-size: clamp(2rem, 3.6vw, 3rem);
        line-height: 1.1;
      }

      .hero-title span {
        color: var(--muted);
        font-weight: 400;
        font-size: 0.8em;
      }

      .meta-line {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .meta-line span {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(8, 16, 24, 0.5);
      }

      .score-line {
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
      }

      .score-ring {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: conic-gradient(var(--accent) calc(var(--score) * 1%), rgba(255, 255, 255, 0.2) 0);
        display: grid;
        place-items: center;
        position: relative;
      }

      .score-ring::after {
        content: "";
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        background: #0c1824;
      }

      .score-ring span {
        position: relative;
        font-weight: 600;
      }

      .score-label {
        font-size: 0.92rem;
        color: var(--muted);
      }

      .score-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .score-actions button {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        padding: 8px 14px;
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        cursor: pointer;
      }

      .score-actions button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #061017;
        border-color: transparent;
      }

      .tagline {
        font-style: italic;
        color: var(--muted);
      }

      .overview h2 {
        margin: 0 0 6px;
        font-size: 1.1rem;
      }

      .overview p {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
      }

      .creator {
        display: grid;
        gap: 4px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .creator strong {
        color: var(--ink);
      }

      .details-grid {
        display: grid;
        grid-template-columns: minmax(320px, 1fr) minmax(240px, 0.32fr);
        gap: 20px;
      }

      .details-main {
        display: grid;
        gap: 20px;
      }

      .cast-block {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 18px;
        display: grid;
        gap: 12px;
      }

      .last-season-block {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 18px;
        display: grid;
        gap: 12px;
      }

      .link-block {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 18px;
        display: grid;
        gap: 12px;
      }

      .link-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .link-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .link-category {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        padding: 6px 12px;
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        cursor: pointer;
        font-size: 0.8rem;
      }

      .link-category.active {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #061017;
        border-color: transparent;
      }

      .link-add-btn {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        padding: 6px 12px;
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        cursor: pointer;
        font-size: 0.82rem;
      }

      .link-form {
        display: none;
        gap: 10px;
        grid-template-columns: minmax(0, 1fr);
        background: rgba(7, 14, 20, 0.6);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px;
      }

      .link-form.show {
        display: grid;
      }

      .link-form input {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 8px 10px;
        background: rgba(6, 12, 18, 0.8);
        color: var(--ink);
        font-size: 0.86rem;
        outline: none;
      }

      .link-form input::placeholder {
        color: rgba(236, 242, 246, 0.5);
      }

      .link-form-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .link-form-actions button {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        padding: 6px 12px;
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        cursor: pointer;
        font-size: 0.82rem;
      }

      .link-form-actions button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #061017;
        border-color: transparent;
      }

      .link-list {
        display: grid;
        gap: 12px;
      }

      .link-card {
        background: rgba(7, 14, 20, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 12px 14px;
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 12px;
        align-items: center;
      }

      .link-meta {
        display: grid;
        gap: 6px;
      }

      .link-line {
        color: var(--muted);
        font-size: 0.84rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .link-action {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        padding: 6px 12px;
        background: rgba(9, 16, 22, 0.6);
        color: var(--ink);
        text-decoration: none;
        font-size: 0.82rem;
        white-space: nowrap;
      }

      .link-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .star-rating {
        display: flex;
        gap: 2px;
      }

      .star-btn {
        border: 0;
        background: transparent;
        color: rgba(236, 242, 246, 0.35);
        cursor: pointer;
        font-size: 0.9rem;
        padding: 2px;
      }

      .star-btn.active {
        color: #f7c948;
      }

      .star-btn.half {
        color: rgba(247, 201, 72, 0.6);
      }

      .rating-summary {
        color: var(--muted);
        font-size: 0.82rem;
        white-space: nowrap;
      }

      .link-action.disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      .season-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
      }

      .season-sub {
        font-size: 0.85rem;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: baseline;
      }

      .season-sub strong {
        color: var(--ink);
        font-weight: 600;
      }

      .season-card {
        display: grid;
        grid-template-columns: minmax(120px, 0.28fr) minmax(220px, 1fr);
        gap: 16px;
        background: rgba(7, 14, 20, 0.7);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px;
      }

      .season-poster {
        border-radius: 12px;
        min-height: 160px;
        background-size: cover;
        background-position: center;
      }

      .season-info {
        display: grid;
        gap: 8px;
        align-content: start;
      }

      .season-title {
        font-weight: 600;
        font-size: 1rem;
      }

      .season-meta {
        color: var(--muted);
        font-size: 0.86rem;
      }

      .season-overview {
        margin: 0;
        color: var(--muted);
        line-height: 1.5;
        font-size: 0.9rem;
      }

      .season-episode {
        font-size: 0.86rem;
        color: var(--muted);
      }

      #last-season-empty {
        display: none;
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .cast-row {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(130px, 1fr);
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 6px;
      }

      .cast-card {
        background: rgba(7, 14, 20, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        overflow: hidden;
        display: grid;
        grid-template-rows: 150px auto;
      }

      .cast-photo {
        background-size: cover;
        background-position: center;
      }

      .cast-meta {
        padding: 10px 12px 12px;
        display: grid;
        gap: 4px;
      }

      .cast-name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .cast-role {
        color: var(--muted);
        font-size: 0.8rem;
      }

      .facts {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 18px;
        display: grid;
        gap: 14px;
        align-content: start;
      }

      .facts-list {
        display: grid;
        gap: 10px;
      }

      .fact {
        display: grid;
        gap: 4px;
        font-size: 0.9rem;
      }

      .fact span {
        color: var(--muted);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .status-line {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .status-line.error {
        color: #f47174;
      }

      @media (max-width: 980px) {
        .hero-content {
          grid-template-columns: 1fr;
        }

        .details-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 720px) {
        header {
          justify-content: center;
        }

        .account {
          width: 100%;
          justify-content: center;
        }

        .season-card {
          grid-template-columns: 1fr;
        }

        .season-poster {
          min-height: 220px;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header>
        <a class="brand" href="/home" aria-label="返回首页">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="brand-title">Pan Score</div>
            <div class="brand-sub">网盘链接评分与推荐</div>
          </div>
        </a>
        <div class="account">
          <div class="lang-select">
            <span>语言</span>
            <select id="language-select" aria-label="选择语言">
              <option value="zh-CN">中文</option>
              <option value="en-US">English</option>
            </select>
          </div>
          <div class="pill user-pill" id="user-pill">访客</div>
          <button class="ghost-btn" id="logout-btn" type="button">退出登录</button>
        </div>
      </header>

      <section class="hero">
        <div class="hero-backdrop" id="hero-backdrop"></div>
        <div class="hero-content">
          <div class="poster-card">
            <div class="poster" id="poster"></div>
          </div>
          <div class="hero-info">
            <div class="kicker">剧集详情</div>
            <h1 class="hero-title" id="hero-title">加载中...</h1>
            <div class="meta-line" id="meta-line"></div>
            <div class="score-line">
              <div class="score-ring" id="score-ring"><span id="score-text">--</span></div>
              <div class="score-label">综合评分</div>
              <div class="score-actions">
                <button class="primary" type="button" id="rate-btn">评分链接</button>
                <button type="button">收藏</button>
              </div>
            </div>
            <div class="tagline" id="tagline"></div>
            <div class="overview">
              <h2>剧情简介</h2>
              <p id="overview">正在获取内容...</p>
            </div>
            <div class="creator" id="creator"></div>
            <div class="status-line" id="status-line"></div>
          </div>
        </div>
      </section>

      <section class="details-grid">
        <div class="details-main">
          <div class="cast-block">
            <div class="section-title">主要演员</div>
            <div class="cast-row" id="cast-row"></div>
          </div>
          <div class="last-season-block">
            <div class="season-header">
              <div class="section-title">Last Season</div>
              <div class="season-sub">Original Air Date <strong id="last-season-air-date">--</strong></div>
            </div>
            <div class="season-card" id="last-season-card">
              <div class="season-poster" id="last-season-poster"></div>
              <div class="season-info">
                <div class="season-title" id="last-season-title">--</div>
                <div class="season-meta" id="last-season-meta">--</div>
                <p class="season-overview" id="last-season-overview"></p>
                <div class="season-episode" id="last-season-episode"></div>
                <div class="season-episode" id="next-season-episode"></div>
              </div>
            </div>
            <div class="status-line" id="last-season-empty">暂无季信息</div>
          </div>
          <div class="link-block">
            <div class="link-header">
              <div class="section-title">分享链接</div>
              <button class="link-add-btn" type="button" id="link-add-btn">新增链接</button>
            </div>
            <form class="link-form" id="link-form">
              <input type="url" id="link-url" placeholder="粘贴分享链接" required />
              <input type="text" id="link-code" placeholder="提取码（可选）" />
              <div class="link-form-actions">
                <button class="primary" type="submit">提交</button>
                <button type="button" id="link-cancel">取消</button>
              </div>
              <div class="status-line" id="link-message"></div>
            </form>
            <div class="link-categories" id="link-categories"></div>
            <div class="status-line" id="link-alert"></div>
            <div class="link-list" id="link-list"></div>
            <div class="status-line" id="link-status">暂无分享链接</div>
          </div>
        </div>
        <aside class="facts">
          <div class="section-title">剧集信息</div>
          <div class="facts-list">
            <div class="fact"><span>状态</span><strong id="fact-status">--</strong></div>
            <div class="fact"><span>季数</span><strong id="fact-seasons">--</strong></div>
            <div class="fact"><span>集数</span><strong id="fact-episodes">--</strong></div>
            <div class="fact"><span>单集时长</span><strong id="fact-runtime">--</strong></div>
            <div class="fact"><span>首播日期</span><strong id="fact-first">--</strong></div>
            <div class="fact"><span>语言</span><strong id="fact-language">--</strong></div>
            <div class="fact"><span>播出平台</span><strong id="fact-networks">--</strong></div>
          </div>
        </aside>
      </section>
    </main>

    <script>
      const heroBackdrop = document.getElementById("hero-backdrop");
      const heroTitle = document.getElementById("hero-title");
      const metaLine = document.getElementById("meta-line");
      const poster = document.getElementById("poster");
      const overview = document.getElementById("overview");
      const tagline = document.getElementById("tagline");
      const creator = document.getElementById("creator");
      const scoreRing = document.getElementById("score-ring");
      const scoreText = document.getElementById("score-text");
      const castRow = document.getElementById("cast-row");
      const statusLine = document.getElementById("status-line");
      const userPill = document.getElementById("user-pill");
      const languageSelect = document.getElementById("language-select");
      const logoutBtn = document.getElementById("logout-btn");
      const trailerBtn = document.getElementById("trailer-btn");
      const lastSeasonCard = document.getElementById("last-season-card");
      const lastSeasonPoster = document.getElementById("last-season-poster");
      const lastSeasonTitle = document.getElementById("last-season-title");
      const lastSeasonMeta = document.getElementById("last-season-meta");
      const lastSeasonOverview = document.getElementById("last-season-overview");
      const lastSeasonEpisode = document.getElementById("last-season-episode");
      const nextSeasonEpisode = document.getElementById("next-season-episode");
      const lastSeasonAirDate = document.getElementById("last-season-air-date");
      const lastSeasonEmpty = document.getElementById("last-season-empty");
      const linkList = document.getElementById("link-list");
      const linkStatus = document.getElementById("link-status");
      const linkAddBtn = document.getElementById("link-add-btn");
      const linkForm = document.getElementById("link-form");
      const linkUrlInput = document.getElementById("link-url");
      const linkCodeInput = document.getElementById("link-code");
      const linkMessage = document.getElementById("link-message");
      const linkCancelBtn = document.getElementById("link-cancel");
      const linkCategories = document.getElementById("link-categories");
      const linkAlert = document.getElementById("link-alert");

      const factStatus = document.getElementById("fact-status");
      const factSeasons = document.getElementById("fact-seasons");
      const factEpisodes = document.getElementById("fact-episodes");
      const factRuntime = document.getElementById("fact-runtime");
      const factFirst = document.getElementById("fact-first");
      const factLanguage = document.getElementById("fact-language");
      const factNetworks = document.getElementById("fact-networks");

      const token = localStorage.getItem("access_token");
      const tmdbImageBase = "https://image.tmdb.org/t/p/";
      const defaultLanguage = "zh-CN";

      const getPreferredLanguage = () => {
        const stored = localStorage.getItem("tmdb_language");
        if (stored) {
          return stored;
        }
        localStorage.setItem("tmdb_language", defaultLanguage);
        return defaultLanguage;
      };

      const applyLanguageSelection = () => {
        if (languageSelect) {
          languageSelect.value = getPreferredLanguage();
        }
      };

      const withLanguage = (url) => {
        const language = getPreferredLanguage();
        const joiner = url.includes("?") ? "&" : "?";
        return `${url}${joiner}language=${encodeURIComponent(language)}`;
      };

      const setUserPill = (label) => {
        const text = (label || "访客").trim();
        const initial = text ? text[0].toUpperCase() : "?";
        userPill.textContent = initial;
        userPill.title = label || "访客";
      };

      const getSeriesId = () => {
        const match = window.location.pathname.match(/\/series\/(\d+)/);
        if (match) {
          return match[1];
        }
        const params = new URLSearchParams(window.location.search);
        return params.get("id") || params.get("tv_id");
      };

      const buildImage = (path, size) => {
        if (!path) {
          return "linear-gradient(135deg, rgba(17, 181, 164, 0.3), rgba(55, 197, 240, 0.2))";
        }
        return `url(${tmdbImageBase}${size}${path})`;
      };

      const formatDate = (value) => value || "--";

      const languageName = (code) => {
        if (!code) return "--";
        try {
          const display = new Intl.DisplayNames(["zh"], { type: "language" });
          return display.of(code) || code;
        } catch (error) {
          return code;
        }
      };

      const setStatus = (message, isError = false) => {
        statusLine.textContent = message;
        statusLine.classList.toggle("error", isError);
      };

      let currentTitlePayload = null;
      let cachedShareLinks = [];
      let currentProvider = "quark";
      const userRatings = new Map();

      const providerLabels = {
        quark: "Quark",
        baidu: "Baidu",
        aliyun: "Aliyun",
        onedrive: "OneDrive",
        other: "其他",
      };

      const providerOrder = ["quark", "baidu", "aliyun", "onedrive", "other"];

      const normalizeProvider = (provider) => {
        const value = (provider || "").toLowerCase();
        if (providerOrder.includes(value)) {
          return value;
        }
        return "other";
      };

      const renderCast = (cast) => {
        castRow.innerHTML = "";
        if (!cast.length) {
          const empty = document.createElement("div");
          empty.className = "status-line";
          empty.textContent = "暂无演员信息";
          castRow.appendChild(empty);
          return;
        }
        cast.forEach((member) => {
          const card = document.createElement("div");
          card.className = "cast-card";

          const photo = document.createElement("div");
          photo.className = "cast-photo";
          photo.style.backgroundImage = buildImage(member.profile_path, "w185");

          const meta = document.createElement("div");
          meta.className = "cast-meta";

          const name = document.createElement("div");
          name.className = "cast-name";
          name.textContent = member.name || "--";

          const role = document.createElement("div");
          role.className = "cast-role";
          role.textContent = member.character || "--";

          meta.appendChild(name);
          meta.appendChild(role);
          card.appendChild(photo);
          card.appendChild(meta);
          castRow.appendChild(card);
        });
      };

      const pickLastSeason = (detail) => {
        const seasons = (detail.seasons || []).filter((season) => season && typeof season === "object");
        if (!seasons.length) {
          return null;
        }

        const lastEpisodeSeason = detail.last_episode_to_air?.season_number;
        if (lastEpisodeSeason !== undefined && lastEpisodeSeason !== null) {
          const match = seasons.find((season) => season.season_number === lastEpisodeSeason);
          if (match) {
            return match;
          }
        }

        const candidates = seasons.filter((season) => season.season_number !== 0);
        const withDates = candidates.filter((season) => season.air_date);
        if (withDates.length) {
          return withDates.reduce((latest, season) => (season.air_date > latest.air_date ? season : latest));
        }

        if (candidates.length) {
          return candidates.reduce((latest, season) =>
            (season.season_number || 0) > (latest.season_number || 0) ? season : latest
          );
        }

        return seasons[seasons.length - 1];
      };

      const renderLastSeason = (detail) => {
        const season = pickLastSeason(detail);
        if (!season) {
          lastSeasonCard.style.display = "none";
          lastSeasonEmpty.style.display = "block";
          lastSeasonAirDate.textContent = "--";
          lastSeasonTitle.textContent = "--";
          lastSeasonMeta.textContent = "--";
          lastSeasonOverview.textContent = "";
          lastSeasonEpisode.textContent = "";
          nextSeasonEpisode.textContent = "";
          return;
        }

        lastSeasonCard.style.display = "grid";
        lastSeasonEmpty.style.display = "none";
        lastSeasonPoster.style.backgroundImage = buildImage(season.poster_path, "w342");
        lastSeasonTitle.textContent = season.name || `第 ${season.season_number} 季`;

        const seasonMetaParts = [];
        if (season.air_date) {
          seasonMetaParts.push(season.air_date.slice(0, 4));
        }
        if (season.episode_count) {
          seasonMetaParts.push(`${season.episode_count} 集`);
        }
        lastSeasonMeta.textContent = seasonMetaParts.join(" · ") || "--";
        lastSeasonOverview.textContent = season.overview || "暂无简介";
        lastSeasonAirDate.textContent = season.air_date ? formatDate(season.air_date) : "--";

        const lastEpisode = detail.last_episode_to_air;
        if (lastEpisode) {
          const episodeName = lastEpisode.name ||
            (lastEpisode.episode_number ? `第 ${lastEpisode.episode_number} 集` : "最新一集");
          const episodeCode = lastEpisode.season_number != null && lastEpisode.episode_number != null
            ? `S${lastEpisode.season_number}E${lastEpisode.episode_number}`
            : "";
          const episodeDate = lastEpisode.air_date ? formatDate(lastEpisode.air_date) : "";
          const episodeParts = [episodeName];
          if (episodeCode) {
            episodeParts.push(episodeCode);
          }
          if (episodeDate) {
            episodeParts.push(episodeDate);
          }
          lastSeasonEpisode.textContent = `最新集：${episodeParts.join(" · ")}`;
        } else {
          lastSeasonEpisode.textContent = "暂无最新集信息";
        }

        const nextEpisode = detail.next_episode_to_air;
        if (nextEpisode) {
          const nextName = nextEpisode.name ||
            (nextEpisode.episode_number ? `第 ${nextEpisode.episode_number} 集` : "下一集");
          const nextCode = nextEpisode.season_number != null && nextEpisode.episode_number != null
            ? `S${nextEpisode.season_number}E${nextEpisode.episode_number}`
            : "";
          const nextDate = nextEpisode.air_date ? formatDate(nextEpisode.air_date) : "待定";
          const nextParts = [nextName];
          if (nextCode) {
            nextParts.push(nextCode);
          }
          nextParts.push(`预计播出：${nextDate}`);
          nextSeasonEpisode.textContent = `下一集：${nextParts.join(" · ")}`;
        } else {
          nextSeasonEpisode.textContent = "暂无下一集信息";
        }
      };

      const renderLinkCard = (link) => {
        const card = document.createElement("div");
        card.className = "link-card";

        const meta = document.createElement("div");
        meta.className = "link-meta";

        const line = document.createElement("div");
        line.className = "link-line";
        line.textContent = link.url
          ? link.access_code
            ? `${link.url}  提取码：${link.access_code}`
            : link.url
          : "--";
        meta.appendChild(line);

        const actions = document.createElement("div");
        actions.className = "link-actions";

        const action = document.createElement("a");
        action.className = "link-action";
        action.textContent = "打开链接";
        if (link.url) {
          action.href = link.url;
          action.target = "_blank";
          action.rel = "noopener";
        } else {
          action.href = "#";
          action.classList.add("disabled");
          action.setAttribute("aria-disabled", "true");
        }

        const stars = document.createElement("div");
        stars.className = "star-rating";
        const userScore = userRatings.get(link.id);
        for (let index = 1; index <= 5; index += 1) {
          const star = document.createElement("button");
          star.type = "button";
          star.className = "star-btn";
          star.textContent = "★";
          if (userScore != null) {
            if (userScore >= index) {
              star.classList.add("active");
            } else if (userScore >= index - 0.5) {
              star.classList.add("half");
            }
          }
          star.addEventListener("click", (event) => {
            const rect = star.getBoundingClientRect();
            const isHalf = event.clientX - rect.left < rect.width / 2;
            const score = (index - 1) + (isHalf ? 0.5 : 1);
            submitRating(link.id, score);
          });
          stars.appendChild(star);
        }

        const ratingSummary = document.createElement("div");
        ratingSummary.className = "rating-summary";
        const avgScore = link.avg_score != null ? Number(link.avg_score).toFixed(1) : "--";
        const scoreCount = link.score_count != null ? link.score_count : 0;
        const summary = `${avgScore} · ${scoreCount} 人`;
        ratingSummary.textContent = userScore != null ? `我的 ${userScore} · ${summary}` : summary;

        actions.appendChild(action);
        actions.appendChild(stars);
        actions.appendChild(ratingSummary);

        card.appendChild(meta);
        card.appendChild(actions);
        return card;
      };

      const renderShareLinks = () => {
        linkList.innerHTML = "";
        linkAlert.textContent = "";
        linkAlert.classList.remove("error");

        if (!cachedShareLinks || cachedShareLinks.length === 0) {
          linkStatus.textContent = "暂无分享链接";
          linkStatus.classList.remove("error");
          linkStatus.style.display = "block";
          return;
        }

        linkStatus.style.display = "none";
        linkStatus.classList.remove("error");
        const filtered = currentProvider === "all"
          ? cachedShareLinks
          : cachedShareLinks.filter((link) => normalizeProvider(link.provider) === currentProvider);

        if (!filtered.length) {
          linkStatus.textContent = "暂无分享链接";
          linkStatus.style.display = "block";
          return;
        }

        filtered.forEach((link) => {
          linkList.appendChild(renderLinkCard(link));
        });
      };

      const renderCategories = (groups, totalCount) => {
        linkCategories.innerHTML = "";
        const categories = [{ key: "all", label: "全部", count: totalCount }];
        providerOrder.forEach((providerKey) => {
          const links = groups[providerKey];
          if (links && links.length) {
            categories.push({
              key: providerKey,
              label: providerLabels[providerKey] || "其他",
              count: links.length,
            });
          }
        });

        categories.forEach((item) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "link-category";
          if (item.key === currentProvider) {
            btn.classList.add("active");
          }
          btn.textContent = `${item.label} (${item.count})`;
          btn.addEventListener("click", () => {
            currentProvider = item.key;
            renderShareLinks();
            renderCategories(groups, totalCount);
          });
          linkCategories.appendChild(btn);
        });
      };

      const setShareLinks = (links) => {
        cachedShareLinks = Array.isArray(links) ? links : [];
        const groups = {};
        cachedShareLinks.forEach((link) => {
          const key = normalizeProvider(link.provider);
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(link);
        });
        if (currentProvider !== "all" && !groups[currentProvider]) {
          currentProvider = "all";
        }
        renderCategories(groups, cachedShareLinks.length);
        renderShareLinks();
      };

      const loadShareLinks = async () => {
        if (!currentTitlePayload) {
          return;
        }
        const query = new URLSearchParams({
          tmdb_id: String(currentTitlePayload.tmdb_id),
          media_type: currentTitlePayload.media_type,
        });
        try {
          const response = await fetch(`/api/v1/share-links?${query}`);
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "加载失败");
          }
          setShareLinks(data.results || []);
          await loadUserRatings();
        } catch (error) {
          linkStatus.textContent = `分享链接加载失败：${error.message}`;
          linkStatus.classList.add("error");
          linkStatus.style.display = "block";
        }
      };

      const loadUserRatings = async () => {
        if (!token || !currentTitlePayload) {
          userRatings.clear();
          renderShareLinks();
          return;
        }
        const query = new URLSearchParams({
          tmdb_id: String(currentTitlePayload.tmdb_id),
          media_type: currentTitlePayload.media_type,
        });
        try {
          const response = await fetch(`/api/v1/share-links/ratings?${query}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "加载失败");
          }
          userRatings.clear();
          (data.ratings || []).forEach((item) => {
            userRatings.set(item.link_id, item.score);
          });
          renderShareLinks();
        } catch (error) {
          userRatings.clear();
          renderShareLinks();
        }
      };

      const submitRating = async (linkId, score) => {
        if (!token) {
          linkAlert.textContent = "请先登录后评分。";
          linkAlert.classList.add("error");
          return;
        }
        linkAlert.textContent = "提交评分中...";
        linkAlert.classList.remove("error");
        try {
          const response = await fetch(`/api/v1/share-links/${linkId}/rating`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ score }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "提交失败");
          }
          userRatings.set(linkId, score);
          if (data.link) {
            cachedShareLinks = cachedShareLinks.map((item) =>
              item.id === data.link.id ? data.link : item
            );
          }
          linkAlert.textContent = "评分成功";
          renderShareLinks();
        } catch (error) {
          linkAlert.textContent = `评分失败：${error.message}`;
          linkAlert.classList.add("error");
        }
      };

      const submitShareLink = async () => {
        if (!currentTitlePayload) {
          return;
        }
        const url = linkUrlInput.value.trim();
        if (!url) {
          linkMessage.textContent = "请填写分享链接。";
          linkMessage.classList.add("error");
          return;
        }
        linkMessage.textContent = "提交中...";
        linkMessage.classList.remove("error");
        try {
          const response = await fetch("/api/v1/share-links", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...currentTitlePayload,
              url,
              access_code: linkCodeInput.value.trim(),
            }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "提交失败");
          }
          linkMessage.textContent = "提交成功";
          linkUrlInput.value = "";
          linkCodeInput.value = "";
          linkForm.classList.remove("show");
          await loadShareLinks();
        } catch (error) {
          linkMessage.textContent = `提交失败：${error.message}`;
          linkMessage.classList.add("error");
        }
      };

      const renderDetails = (detail) => {
        const title = detail.name || detail.title || "未知剧集";
        const airDate = detail.first_air_date || detail.release_date;
        const year = airDate ? `（${airDate.slice(0, 4)}）` : "";
        heroTitle.innerHTML = `${title} <span>${year}</span>`;

        heroBackdrop.style.backgroundImage = buildImage(detail.backdrop_path, "w1280");
        poster.style.backgroundImage = buildImage(detail.poster_path, "w500");

        const genres = (detail.genres || []).map((item) => item.name).join(" / ") || "类型未知";
        const runtime = detail.episode_run_time && detail.episode_run_time.length
          ? `${detail.episode_run_time[0]} 分钟`
          : detail.runtime
            ? `${detail.runtime} 分钟`
            : "--";

        metaLine.innerHTML = "";
        [
          detail.status || "状态未知",
          genres,
          runtime,
        ].forEach((text) => {
          const pill = document.createElement("span");
          pill.textContent = text;
          metaLine.appendChild(pill);
        });

        const scoreValue = Math.round((detail.vote_average || 0) * 10);
        scoreRing.style.setProperty("--score", scoreValue);
        scoreText.textContent = scoreValue ? `${scoreValue}` : "--";

        tagline.textContent = detail.tagline || "";
        tagline.style.display = detail.tagline ? "block" : "none";

        overview.textContent = detail.overview || "暂无简介";

        const creators = (detail.created_by || []).map((item) => item.name).join("、");
        creator.innerHTML = creators
          ? `<strong>主创</strong> ${creators}`
          : "";

        factStatus.textContent = detail.status || "--";
        factSeasons.textContent = detail.number_of_seasons ? `${detail.number_of_seasons} 季` : "--";
        factEpisodes.textContent = detail.number_of_episodes ? `${detail.number_of_episodes} 集` : "--";
        factRuntime.textContent = runtime;
        factFirst.textContent = formatDate(airDate);
        factLanguage.textContent = languageName(detail.original_language);
        factNetworks.textContent = detail.networks && detail.networks.length
          ? detail.networks.map((item) => item.name).join("、")
          : "--";

        currentTitlePayload = {
          tmdb_id: detail.id,
          media_type: detail.first_air_date ? "tv" : "movie",
          name: detail.name || detail.title,
          original_name: detail.original_name || detail.original_title,
          first_air_date: detail.first_air_date,
          release_date: detail.release_date,
          poster_path: detail.poster_path,
          status: detail.status,
        };

        renderLastSeason(detail);
        loadShareLinks();
      };

      const renderTrailer = (videos) => {
        if (!trailerBtn) {
          return;
        }
        const trailer = (videos.results || []).find(
          (item) => item.site === "YouTube" && item.type === "Trailer"
        );
        if (!trailer) {
          trailerBtn.disabled = true;
          trailerBtn.textContent = "暂无预告";
          return;
        }
        trailerBtn.dataset.url = `https://www.youtube.com/watch?v=${trailer.key}`;
      };

      const initSession = async () => {
        if (!token) {
          setUserPill("未登录");
          setTimeout(() => {
            window.location.href = "/login";
          }, 800);
          return;
        }

        try {
          const response = await fetch("/api/v1/auth/me", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Session invalid");
          }

          const data = await response.json();
          setUserPill(data.email);
        } catch (error) {
          setUserPill("会话过期");
          localStorage.removeItem("access_token");
          setTimeout(() => {
            window.location.href = "/login";
          }, 800);
        }
      };

      const loadSeries = async () => {
        const seriesId = getSeriesId();
        if (!seriesId) {
          setStatus("缺少剧集 ID，请从搜索结果进入。", true);
          return;
        }

        setStatus("加载中...");
        try {
          const detailRes = await fetch(withLanguage(`/api/v1/tmdb/tv/${seriesId}`));
          const detail = await detailRes.json();

          if (detailRes.ok) {
            const [creditsRes, videosRes] = await Promise.all([
              fetch(withLanguage(`/api/v1/tmdb/tv/${seriesId}/credits`)),
              fetch(withLanguage(`/api/v1/tmdb/tv/${seriesId}/videos`)),
            ]);
            const credits = await creditsRes.json();
            const videos = await videosRes.json();

            renderDetails(detail);
            renderCast((credits.cast || []).slice(0, 12));
            renderTrailer(videos || { results: [] });
            setStatus("");
            return;
          }

          const movieDetailRes = await fetch(withLanguage(`/api/v1/tmdb/movie/${seriesId}`));
          const movieDetail = await movieDetailRes.json();
          if (!movieDetailRes.ok) {
            throw new Error(movieDetail.error || detail.error || "加载失败");
          }

          const [movieCreditsRes, movieVideosRes] = await Promise.all([
            fetch(withLanguage(`/api/v1/tmdb/movie/${seriesId}/credits`)),
            fetch(withLanguage(`/api/v1/tmdb/movie/${seriesId}/videos`)),
          ]);
          const movieCredits = await movieCreditsRes.json();
          const movieVideos = await movieVideosRes.json();

          renderDetails(movieDetail);
          renderCast((movieCredits.cast || []).slice(0, 12));
          renderTrailer(movieVideos || { results: [] });
          setStatus("");
        } catch (error) {
          setStatus(`加载失败：${error.message}`, true);
        }
      };

      if (trailerBtn) {
        trailerBtn.addEventListener("click", () => {
          const url = trailerBtn.dataset.url;
          if (url) {
            window.open(url, "_blank");
          }
        });
      }

      linkAddBtn.addEventListener("click", () => {
        linkForm.classList.toggle("show");
        linkMessage.textContent = "";
        linkMessage.classList.remove("error");
      });

      linkCancelBtn.addEventListener("click", () => {
        linkForm.classList.remove("show");
        linkMessage.textContent = "";
        linkMessage.classList.remove("error");
      });

      linkForm.addEventListener("submit", (event) => {
        event.preventDefault();
        submitShareLink();
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("access_token");
        window.location.href = "/login";
      });

      languageSelect.addEventListener("change", () => {
        localStorage.setItem("tmdb_language", languageSelect.value);
        loadSeries();
      });

      applyLanguageSelection();
      initSession();
      loadSeries();
    </script>
  </body>
</html>
